{"componentChunkName":"component---src-pages-advanced-run-on-openshift-index-mdx","path":"/advanced/run-on-openshift/","result":{"pageContext":{"frontmatter":{"description":"Advanced / Run On Openshift","title":"Advanced / Run On Openshift"},"relativePagePath":"/advanced/run-on-openshift/index.mdx","titleType":"page","MdxNode":{"id":"1f1ae065-148e-58a3-ac01-312893a97df9","children":[],"parent":"98036287-1fb1-5b7d-b4f0-ee546a34ffbe","internal":{"content":"# Running deployer as a pod for existing OpenShift cluster\n\n## Collect cluster credentials\n* Cluster: ...\n* OpenShift admin user: `kubeadmin`\n* Password: ...\n\n## Login to cluster\n```\noc login ... --insecure-skip-tls-verify\n```\n\nKeep the login command, you will need it later to set the vault secret the deployer will use.\n\n## Create configuration\n```\nexport CONFIG_DIR=$PWD/cpd-config && mkdir -p $CONFIG_DIR/config\n\ncat << EOF > $CONFIG_DIR/config/cpd-config.yaml\n---\nglobal_config:\n  environment_name: demo\n  cloud_platform: existing-ocp\n\nopenshift:\n- name: cpd-demo\n  ocp_version: 4.8\n  cluster_name: cpd-demo\n  domain_name: example.com\n  openshift_storage:\n  - storage_name: nfs-storage\n    storage_type: nfs\n    ocp_storage_class_file: managed-nfs-storage\n    ocp_storage_class_block: managed-nfs-storage\n\ncp4d:\n- project: cpd-instance\n  openshift_cluster_name: cpd-demo\n  cp4d_version: 4.5.0\n  olm_utils: True\n  accept_licenses: True\n  cartridges:\n  - name: cp-foundation\n    license_service:\n      state: disabled\n      threads_per_core: 2\n  - name: lite\n\n#\n# All tested cartridges. To install, change the \"state\" property to \"installed\". To uninstall, change the state\n# to \"removed\" or comment out the entire cartridge. Make sure that the \"-\" and properties are aligned with the lite\n# cartridge; the \"-\" is at position 3 and the property starts at position 5.\n#\n\n  - name: analyticsengine \n    size: small \n    state: removed\n\n  - name: bigsql\n    state: removed\n\n  - name: ca\n    size: small\n    instances:\n    - name: ca-instance\n      metastore_ref: ca-metastore\n    state: removed\n\n  - name: cde\n    state: removed\n\n  - name: datagate\n    state: removed\n\n  - name: datastage-ent-plus\n    state: removed\n\n  - name: db2\n    size: small\n    instances:\n    - name: ca-metastore\n      metadata_size_gb: 20\n      data_size_gb: 20\n      backup_size_gb: 20  \n      transactionlog_size_gb: 20\n    state: removed\n\n  - name: db2u\n    state: removed\n\n  - name: db2wh\n    state: removed\n\n  - name: dmc\n    state: removed\n\n  - name: dods\n    size: small\n    state: removed\n\n  - name: dp\n    size: small\n    state: removed\n\n  - name: dv\n    size: small \n    instances:\n    - name: data-virtualization\n    state: removed\n\n  - name: hadoop\n    size: small\n    state: removed\n\n  - name: mdm\n    size: small\n    wkc_enabled: true\n    state: removed\n\n  - name: openpages\n    state: removed\n\n  - name: planning-analytics\n    state: removed\n\n  - name: rstudio\n    size: small\n    state: removed\n\n  - name: spss\n    state: removed\n\n  - name: voice-gateway\n    replicas: 1\n    state: removed\n\n  - name: watson-assistant\n    size: small\n    state: removed\n\n  - name: watson-discovery\n    state: removed\n\n  - name: watson-ks\n    size: small\n    state: removed\n\n  - name: watson-openscale\n    size: small\n    state: removed\n\n  - name: watson-speech\n    stt_size: xsmall\n    tts_size: xsmall\n    state: removed\n\n  - name: wkc\n    size: small\n    state: removed\n\n  - name: wml\n    size: small\n    state: installed\n\n  - name: wml-accelerator\n    replicas: 1\n    size: small\n    state: removed\n\n  - name: wsl\n    state: installed\n\nEOF\n```\n\n## Prepare the deployer project\n```\noc new-project cloud-pak-deployer \n\noc project cloud-pak-deployer\noc create serviceaccount cloud-pak-deployer-sa\noc adm policy add-scc-to-user privileged -z cloud-pak-deployer-sa\noc adm policy add-cluster-role-to-user cluster-admin -z cloud-pak-deployer-sa\n```\n\n## Build deployer image and push to the internal registry\nBuilding the deployer image typically takes ~5 minutes. Only do this if the image has not been built yet.\n\n```\nif ! oc get istag -n cloud-pak-deployer cloud-pak-deployer:latest --no-headers 2> /dev/null;then \n\ncat << EOF | oc apply -f -\napiVersion: image.openshift.io/v1\nkind: ImageStream\nmetadata:\n  name: cloud-pak-deployer\nspec:\n  lookupPolicy:\n    local: true\nEOF\n\ncat << EOF | oc apply -f -\napiVersion: build.openshift.io/v1\nkind: BuildConfig\nmetadata:\n  name: cloud-pak-deployer-bc\n  namespace: cloud-pak-deployer\nspec:\n  source:\n    type: Git\n    git:\n      uri: https://github.com/IBM/cloud-pak-deployer\n  strategy:\n    type: Docker                      \n  output:\n    to:\n      kind: ImageStreamTag\n      name: cloud-pak-deployer:latest\nEOF\n\n  oc delete build -n cloud-pak-deployer -l buildconfig=cloud-pak-deployer-bc\n  oc start-build -n cloud-pak-deployer bc/cloud-pak-deployer-bc\n\necho \"Wait for image to be built and pushed to internal registry...\"\nwhile ! oc get istag -n cloud-pak-deployer cloud-pak-deployer:latest 2>/dev/null;do\n  sleep 1\ndone\n\nfi\n```\n\n## Set configuration\n```\noc create cm -n cloud-pak-deployer cloud-pak-deployer-config\noc set data -n cloud-pak-deployer cm/cloud-pak-deployer-config \\\n  --from-file=$CONFIG_DIR/config/cpd-config.yaml\n```\n  \n## Start the deployer job\n```\nexport DEPLOYER_SC=managed-nfs-storage\n\ncat << EOF | oc apply -f -\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: cloud-pak-deployer-status\n  namespace: cloud-pak-deployer\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: $DEPLOYER_SC\nEOF\n\ncat << EOF | oc apply -f -\napiVersion: batch/v1\nkind: Job\nmetadata:\n  labels:\n    app: cloud-pak-deployer\n  name: cloud-pak-deployer\n  namespace: cloud-pak-deployer\nspec:\n  parallelism: 1\n  completions: 1\n  backoffLimit: 0\n  template:\n    metadata:\n      name: cloud-pak-deployer\n      labels:\n        app: cloud-pak-deployer\n    spec:\n      initContainers:\n      - name: wait-config\n        image: cloud-pak-deployer:latest\n        command: ['sh', '-c', 'until [ -f /tmp/cpd-config-ready ]; do echo Waiting for /tmp/cpd-config-ready file; sleep 1; done; echo \"Configuration is ready, starting deployer\"']\n        env:\n        - name: CONFIG_DIR\n          value: /Data/cpd-config\n        - name: STATUS_DIR\n          value: /Data/cpd-status\n        volumeMounts:\n        - name: config-volume\n          mountPath: /Data/cpd-config/config\n        - name: status-volume\n          mountPath: /Data/cpd-status\n      containers:\n      - name: cloud-pak-deployer\n        image: cloud-pak-deployer:latest\n        imagePullPolicy: Always\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        env:\n        - name: CONFIG_DIR\n          value: /Data/cpd-config\n        - name: STATUS_DIR\n          value: /Data/cpd-status\n        volumeMounts:\n        - name: config-volume\n          mountPath: /Data/cpd-config/config\n        - name: status-volume\n          mountPath: /Data/cpd-status\n        command: [\"/bin/sh\",\"-xc\"]\n        args: \n          - /cloud-pak-deployer/cp-deploy.sh env apply -v\n      restartPolicy: Never\n      securityContext:\n        runAsUser: 0\n      serviceAccountName: cloud-pak-deployer-sa\n      volumes:\n      - name: config-volume\n        configMap:\n          name: cloud-pak-deployer-config\n      - name: status-volume\n        persistentVolumeClaim:\n          claimName: cloud-pak-deployer-status        \nEOF\n```\n\nThe OpenShift job consists of 2 containers: `wait-config` and `cloud-pak-deployer`, where the `wait-config` is an \"init\" container, just waiting for the signal that the deployer can start. In the next steps, the deployer configuration and secrets are created inside the pod, then the configuration is marked \"ready\" and deployment can start.\n\n## Copy local configuration and status directory into deployer pod\n```\nexport DEPLOYER_POD=$(oc get po --no-headers -l app=cloud-pak-deployer | head -1 | awk '{print $1}')\n```\n\n## Prepare for deployer run\n```\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs ibm_cp_entitlement_key -vsv \"your_entitlement_key\"\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs cpd-demo-oc-login -vsv \"your_oc_login_command\"\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs cp4d_admin_cpd_instance_cpd_demo -vsv \"your_cp4d_admin_password\"\n\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault list\n```\n\n## Mark the configuration ready to start the deployment\n```\noc rsh -c wait-config $DEPLOYER_POD bash -c 'touch /tmp/cpd-config-ready; chmod 777 /tmp/cpd-config-ready'\n```\n\n## Follow the logs of the deployment\n```\noc logs -f $DEPLOYER_POD\n```\n\nIn some cases, especially if the OpenShift cluster is remote from where the `oc` command is running, the `oc logs -f` command may terminate abruptly. ","type":"Mdx","contentDigest":"7943cd05a5d3ab25017127b85f78c63e","owner":"gatsby-plugin-mdx","counter":202},"frontmatter":{"description":"Advanced / Run On Openshift","title":"Advanced / Run On Openshift"},"exports":{},"rawBody":"# Running deployer as a pod for existing OpenShift cluster\n\n## Collect cluster credentials\n* Cluster: ...\n* OpenShift admin user: `kubeadmin`\n* Password: ...\n\n## Login to cluster\n```\noc login ... --insecure-skip-tls-verify\n```\n\nKeep the login command, you will need it later to set the vault secret the deployer will use.\n\n## Create configuration\n```\nexport CONFIG_DIR=$PWD/cpd-config && mkdir -p $CONFIG_DIR/config\n\ncat << EOF > $CONFIG_DIR/config/cpd-config.yaml\n---\nglobal_config:\n  environment_name: demo\n  cloud_platform: existing-ocp\n\nopenshift:\n- name: cpd-demo\n  ocp_version: 4.8\n  cluster_name: cpd-demo\n  domain_name: example.com\n  openshift_storage:\n  - storage_name: nfs-storage\n    storage_type: nfs\n    ocp_storage_class_file: managed-nfs-storage\n    ocp_storage_class_block: managed-nfs-storage\n\ncp4d:\n- project: cpd-instance\n  openshift_cluster_name: cpd-demo\n  cp4d_version: 4.5.0\n  olm_utils: True\n  accept_licenses: True\n  cartridges:\n  - name: cp-foundation\n    license_service:\n      state: disabled\n      threads_per_core: 2\n  - name: lite\n\n#\n# All tested cartridges. To install, change the \"state\" property to \"installed\". To uninstall, change the state\n# to \"removed\" or comment out the entire cartridge. Make sure that the \"-\" and properties are aligned with the lite\n# cartridge; the \"-\" is at position 3 and the property starts at position 5.\n#\n\n  - name: analyticsengine \n    size: small \n    state: removed\n\n  - name: bigsql\n    state: removed\n\n  - name: ca\n    size: small\n    instances:\n    - name: ca-instance\n      metastore_ref: ca-metastore\n    state: removed\n\n  - name: cde\n    state: removed\n\n  - name: datagate\n    state: removed\n\n  - name: datastage-ent-plus\n    state: removed\n\n  - name: db2\n    size: small\n    instances:\n    - name: ca-metastore\n      metadata_size_gb: 20\n      data_size_gb: 20\n      backup_size_gb: 20  \n      transactionlog_size_gb: 20\n    state: removed\n\n  - name: db2u\n    state: removed\n\n  - name: db2wh\n    state: removed\n\n  - name: dmc\n    state: removed\n\n  - name: dods\n    size: small\n    state: removed\n\n  - name: dp\n    size: small\n    state: removed\n\n  - name: dv\n    size: small \n    instances:\n    - name: data-virtualization\n    state: removed\n\n  - name: hadoop\n    size: small\n    state: removed\n\n  - name: mdm\n    size: small\n    wkc_enabled: true\n    state: removed\n\n  - name: openpages\n    state: removed\n\n  - name: planning-analytics\n    state: removed\n\n  - name: rstudio\n    size: small\n    state: removed\n\n  - name: spss\n    state: removed\n\n  - name: voice-gateway\n    replicas: 1\n    state: removed\n\n  - name: watson-assistant\n    size: small\n    state: removed\n\n  - name: watson-discovery\n    state: removed\n\n  - name: watson-ks\n    size: small\n    state: removed\n\n  - name: watson-openscale\n    size: small\n    state: removed\n\n  - name: watson-speech\n    stt_size: xsmall\n    tts_size: xsmall\n    state: removed\n\n  - name: wkc\n    size: small\n    state: removed\n\n  - name: wml\n    size: small\n    state: installed\n\n  - name: wml-accelerator\n    replicas: 1\n    size: small\n    state: removed\n\n  - name: wsl\n    state: installed\n\nEOF\n```\n\n## Prepare the deployer project\n```\noc new-project cloud-pak-deployer \n\noc project cloud-pak-deployer\noc create serviceaccount cloud-pak-deployer-sa\noc adm policy add-scc-to-user privileged -z cloud-pak-deployer-sa\noc adm policy add-cluster-role-to-user cluster-admin -z cloud-pak-deployer-sa\n```\n\n## Build deployer image and push to the internal registry\nBuilding the deployer image typically takes ~5 minutes. Only do this if the image has not been built yet.\n\n```\nif ! oc get istag -n cloud-pak-deployer cloud-pak-deployer:latest --no-headers 2> /dev/null;then \n\ncat << EOF | oc apply -f -\napiVersion: image.openshift.io/v1\nkind: ImageStream\nmetadata:\n  name: cloud-pak-deployer\nspec:\n  lookupPolicy:\n    local: true\nEOF\n\ncat << EOF | oc apply -f -\napiVersion: build.openshift.io/v1\nkind: BuildConfig\nmetadata:\n  name: cloud-pak-deployer-bc\n  namespace: cloud-pak-deployer\nspec:\n  source:\n    type: Git\n    git:\n      uri: https://github.com/IBM/cloud-pak-deployer\n  strategy:\n    type: Docker                      \n  output:\n    to:\n      kind: ImageStreamTag\n      name: cloud-pak-deployer:latest\nEOF\n\n  oc delete build -n cloud-pak-deployer -l buildconfig=cloud-pak-deployer-bc\n  oc start-build -n cloud-pak-deployer bc/cloud-pak-deployer-bc\n\necho \"Wait for image to be built and pushed to internal registry...\"\nwhile ! oc get istag -n cloud-pak-deployer cloud-pak-deployer:latest 2>/dev/null;do\n  sleep 1\ndone\n\nfi\n```\n\n## Set configuration\n```\noc create cm -n cloud-pak-deployer cloud-pak-deployer-config\noc set data -n cloud-pak-deployer cm/cloud-pak-deployer-config \\\n  --from-file=$CONFIG_DIR/config/cpd-config.yaml\n```\n  \n## Start the deployer job\n```\nexport DEPLOYER_SC=managed-nfs-storage\n\ncat << EOF | oc apply -f -\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: cloud-pak-deployer-status\n  namespace: cloud-pak-deployer\nspec:\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: $DEPLOYER_SC\nEOF\n\ncat << EOF | oc apply -f -\napiVersion: batch/v1\nkind: Job\nmetadata:\n  labels:\n    app: cloud-pak-deployer\n  name: cloud-pak-deployer\n  namespace: cloud-pak-deployer\nspec:\n  parallelism: 1\n  completions: 1\n  backoffLimit: 0\n  template:\n    metadata:\n      name: cloud-pak-deployer\n      labels:\n        app: cloud-pak-deployer\n    spec:\n      initContainers:\n      - name: wait-config\n        image: cloud-pak-deployer:latest\n        command: ['sh', '-c', 'until [ -f /tmp/cpd-config-ready ]; do echo Waiting for /tmp/cpd-config-ready file; sleep 1; done; echo \"Configuration is ready, starting deployer\"']\n        env:\n        - name: CONFIG_DIR\n          value: /Data/cpd-config\n        - name: STATUS_DIR\n          value: /Data/cpd-status\n        volumeMounts:\n        - name: config-volume\n          mountPath: /Data/cpd-config/config\n        - name: status-volume\n          mountPath: /Data/cpd-status\n      containers:\n      - name: cloud-pak-deployer\n        image: cloud-pak-deployer:latest\n        imagePullPolicy: Always\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        env:\n        - name: CONFIG_DIR\n          value: /Data/cpd-config\n        - name: STATUS_DIR\n          value: /Data/cpd-status\n        volumeMounts:\n        - name: config-volume\n          mountPath: /Data/cpd-config/config\n        - name: status-volume\n          mountPath: /Data/cpd-status\n        command: [\"/bin/sh\",\"-xc\"]\n        args: \n          - /cloud-pak-deployer/cp-deploy.sh env apply -v\n      restartPolicy: Never\n      securityContext:\n        runAsUser: 0\n      serviceAccountName: cloud-pak-deployer-sa\n      volumes:\n      - name: config-volume\n        configMap:\n          name: cloud-pak-deployer-config\n      - name: status-volume\n        persistentVolumeClaim:\n          claimName: cloud-pak-deployer-status        \nEOF\n```\n\nThe OpenShift job consists of 2 containers: `wait-config` and `cloud-pak-deployer`, where the `wait-config` is an \"init\" container, just waiting for the signal that the deployer can start. In the next steps, the deployer configuration and secrets are created inside the pod, then the configuration is marked \"ready\" and deployment can start.\n\n## Copy local configuration and status directory into deployer pod\n```\nexport DEPLOYER_POD=$(oc get po --no-headers -l app=cloud-pak-deployer | head -1 | awk '{print $1}')\n```\n\n## Prepare for deployer run\n```\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs ibm_cp_entitlement_key -vsv \"your_entitlement_key\"\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs cpd-demo-oc-login -vsv \"your_oc_login_command\"\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault set \\\n  -vs cp4d_admin_cpd_instance_cpd_demo -vsv \"your_cp4d_admin_password\"\n\noc rsh -c wait-config $DEPLOYER_POD /cloud-pak-deployer/cp-deploy.sh vault list\n```\n\n## Mark the configuration ready to start the deployment\n```\noc rsh -c wait-config $DEPLOYER_POD bash -c 'touch /tmp/cpd-config-ready; chmod 777 /tmp/cpd-config-ready'\n```\n\n## Follow the logs of the deployment\n```\noc logs -f $DEPLOYER_POD\n```\n\nIn some cases, especially if the OpenShift cluster is remote from where the `oc` command is running, the `oc logs -f` command may terminate abruptly. ","fileAbsolutePath":"/home/runner/work/cloud-pak-deployer/cloud-pak-deployer/doc/src/pages/advanced/run-on-openshift/index.mdx"}}},"staticQueryHashes":["1364590287","137577622","137577622","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","768070550"]}