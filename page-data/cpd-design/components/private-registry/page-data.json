{"componentChunkName":"component---src-pages-cpd-design-components-private-registry-index-mdx","path":"/cpd-design/components/private-registry/","result":{"pageContext":{"frontmatter":{"title":"Private registry"},"relativePagePath":"/cpd-design/components/private-registry/index.mdx","titleType":"page","MdxNode":{"id":"2f351c6c-dd6c-5b14-9311-708e87627c5a","children":[],"parent":"6971cf0f-b6bc-5d14-b835-477c6621eef4","internal":{"content":"---\ntitle: Private registry\n---\n\n# Private registry\n\nIn cases where the OpenShift cluster is in an environment with limited internet connectivity, you may want OpenShift to pull Cloud Pak images from a private image registry (aka container registry). There may also be other reasons for choosing a private registry over the entitled registry.\n\n## Configuring a private registry\nThe below steps outline how to configure a private registry for a Cloud Pak deployment. When the `image_registry` object is referenced by the Cloud Pak object (such as `cp4d`), the deployer makes the following changes in OpenShift so that images are pulled from the private registry:\n* Global pull secret: The image registry's credentials are retrieved from the vault (the secret name must be `image-registry-<name>` and an entry for the registry is added to the global pull secret (secret `pull-secret` in project `openshift-config`).\n* ImageContentSourcePolicy: This is a mapping between the original location of the image, for example `quay.io/opencloudio/zen-metastoredb@sha256:582cac2366dda8520730184dec2c430e51009a854ed9ccea07db9c3390e13b29` is mapped to `registry.coc.uk.ibm.com:15000/opencloudio/zen-metastoredb@sha256:582cac2366dda8520730184dec2c430e51009a854ed9ccea07db9c3390e13b29`.\n* Image registry settings: OpenShift keeps image registry settings in custom resource `image.config.openshift.io/cluster`. If a private registry with a self-signed certificate is configured, certificate authority's PEM secret must be created as a configmap in the `openshift-config` project. The deployer uses the vault secret referenced in `registry_trusted_ca_secret` property to create or update the configmap so that OpenShift can connect to the registry in a secure manner. Alternatively, you add the `registry_insecure: true` property to pull images without checking the certificate.\n\n### Using the IBM Container Registry as a private registry\nIf you want to use a private registry when running the deployer for a ROKS cluster on IBM Cloud, you must use the IBM Container Registry (ICR) service. The deployer will automatically create the specified namespace in the ICR and set up the credentials accordingly. Configure an [image_registry](/cpd-design/objects/cloud-paks#image_registry) object with the host name of the private registry and the namespace that holds the images. An example of using the ICR as a private registry:\n\n```\nimage_registry:\n- name: cpd409\n  registry_host_name: de.icr.io\n  registry_namespace: cpd409\n```\n\nThe registry host name must end with `icr.io` and the registry namespace is mandatory. No other properties are needed; the deployer will retrieve them from IBM Cloud.\n\nIf you have already created the ICR namespace, create a vault secret for the image registry credentials:\n```\n./cp-deploy.sh vault set \\\n  -vs image-registry-cpd409\n  -vsv \"admin:very_s3cret\"\n```\n\nAn example of configuring the private registry for a `cp4d` object is below:\n```\ncp4d:\n- project: zen-40\n  openshift_cluster_name: {{ env_id }}\n  cp4d_version: 4.0.9\n  openshift_storage_name: ocs-storage\n  image_registry_name: cpd409\n```\n\nThe Cloud Pak for Data installation refers to the `cpd409` `image_registry` object.\n\nIf the `ibm_cp_entitlement_key` secret is in the vault at the time of running the deployer, the required images will be mirrored from the entitled registry to the private registry. If all images are already available in the private registry, just specify the `--skip-mirror-images` flag when you run the deployer.\n\n\n## Using a private registry for the Cloud Pak installation (non-IBM Cloud)\nConfigure an [image_registry](/cpd-design/objects/cloud-paks#image_registry) object with the host name of the private registry and some optional properties such as port number, CA certificate and whether insecure access to the registry is allowed.\n\nExample:\n```\nimage_registry:\n- name: cpd409\n  registry_host_name: registry.coc.uk.ibm.com\n  registry_port: 15000\n  registry_trusted_ca_secret: cpd409-ca-bundle\n```\n\nTo create the vault secret for the image registry credentials:\n```\n./cp-deploy.sh vault set \\\n  -vs image-registry-cpd409\n  -vsv \"admin:very_s3cret\"\n```\n\nTo create the vault secret for the CA bundle:\n```\n./cp-deploy.sh vault set \\\n  -vs cpd409-ca-bundle\n  -vsf /tmp/ca.crt\n```\n\nWhere `ca.crt` looks something like this:\n```\n-----BEGIN CERTIFICATE-----\nMIIFszCCA5ugAwIBAgIUT02v9OdgdvjgQVslCuL0wwCVaE8wDQYJKoZIhvcNAQEL\nBQAwaTELMAkGA1UEBhMCVVMxETAPBgNVBAgMCE5ldyBZb3JrMQ8wDQYDVQQHDAZB\ncm1vbmsxFjAUBgNVBAoMDUlCTSBDbG91ZCBQYWsxHjAcBgNVBAMMFUlCTSBDbG91\n...\nmcutkgtbkq31XYZj0CiM451Qp8KnTx0=\n-----END CERTIFICATE-\n```\n\nAn example of configuring the private registry for a `cp4d` object is below:\n```\ncp4d:\n- project: zen-40\n  openshift_cluster_name: {{ env_id }}\n  cp4d_version: 4.0.9\n  openshift_storage_name: ocs-storage\n  image_registry_name: cpd409\n```\n\nThe Cloud Pak for Data installation refers to the `cpd409` `image_registry` object.\n\nIf the `ibm_cp_entitlement_key` secret is in the vault at the time of running the deployer, the required images will be mirrored from the entitled registry to the private registry. If all images are already available in the private registry, just specify the `--skip-mirror-images` flag when you run the deployer.","type":"Mdx","contentDigest":"2de19a4305cb111190885a754aa62034","owner":"gatsby-plugin-mdx","counter":253},"frontmatter":{"title":"Private registry"},"exports":{},"rawBody":"---\ntitle: Private registry\n---\n\n# Private registry\n\nIn cases where the OpenShift cluster is in an environment with limited internet connectivity, you may want OpenShift to pull Cloud Pak images from a private image registry (aka container registry). There may also be other reasons for choosing a private registry over the entitled registry.\n\n## Configuring a private registry\nThe below steps outline how to configure a private registry for a Cloud Pak deployment. When the `image_registry` object is referenced by the Cloud Pak object (such as `cp4d`), the deployer makes the following changes in OpenShift so that images are pulled from the private registry:\n* Global pull secret: The image registry's credentials are retrieved from the vault (the secret name must be `image-registry-<name>` and an entry for the registry is added to the global pull secret (secret `pull-secret` in project `openshift-config`).\n* ImageContentSourcePolicy: This is a mapping between the original location of the image, for example `quay.io/opencloudio/zen-metastoredb@sha256:582cac2366dda8520730184dec2c430e51009a854ed9ccea07db9c3390e13b29` is mapped to `registry.coc.uk.ibm.com:15000/opencloudio/zen-metastoredb@sha256:582cac2366dda8520730184dec2c430e51009a854ed9ccea07db9c3390e13b29`.\n* Image registry settings: OpenShift keeps image registry settings in custom resource `image.config.openshift.io/cluster`. If a private registry with a self-signed certificate is configured, certificate authority's PEM secret must be created as a configmap in the `openshift-config` project. The deployer uses the vault secret referenced in `registry_trusted_ca_secret` property to create or update the configmap so that OpenShift can connect to the registry in a secure manner. Alternatively, you add the `registry_insecure: true` property to pull images without checking the certificate.\n\n### Using the IBM Container Registry as a private registry\nIf you want to use a private registry when running the deployer for a ROKS cluster on IBM Cloud, you must use the IBM Container Registry (ICR) service. The deployer will automatically create the specified namespace in the ICR and set up the credentials accordingly. Configure an [image_registry](/cpd-design/objects/cloud-paks#image_registry) object with the host name of the private registry and the namespace that holds the images. An example of using the ICR as a private registry:\n\n```\nimage_registry:\n- name: cpd409\n  registry_host_name: de.icr.io\n  registry_namespace: cpd409\n```\n\nThe registry host name must end with `icr.io` and the registry namespace is mandatory. No other properties are needed; the deployer will retrieve them from IBM Cloud.\n\nIf you have already created the ICR namespace, create a vault secret for the image registry credentials:\n```\n./cp-deploy.sh vault set \\\n  -vs image-registry-cpd409\n  -vsv \"admin:very_s3cret\"\n```\n\nAn example of configuring the private registry for a `cp4d` object is below:\n```\ncp4d:\n- project: zen-40\n  openshift_cluster_name: {{ env_id }}\n  cp4d_version: 4.0.9\n  openshift_storage_name: ocs-storage\n  image_registry_name: cpd409\n```\n\nThe Cloud Pak for Data installation refers to the `cpd409` `image_registry` object.\n\nIf the `ibm_cp_entitlement_key` secret is in the vault at the time of running the deployer, the required images will be mirrored from the entitled registry to the private registry. If all images are already available in the private registry, just specify the `--skip-mirror-images` flag when you run the deployer.\n\n\n## Using a private registry for the Cloud Pak installation (non-IBM Cloud)\nConfigure an [image_registry](/cpd-design/objects/cloud-paks#image_registry) object with the host name of the private registry and some optional properties such as port number, CA certificate and whether insecure access to the registry is allowed.\n\nExample:\n```\nimage_registry:\n- name: cpd409\n  registry_host_name: registry.coc.uk.ibm.com\n  registry_port: 15000\n  registry_trusted_ca_secret: cpd409-ca-bundle\n```\n\nTo create the vault secret for the image registry credentials:\n```\n./cp-deploy.sh vault set \\\n  -vs image-registry-cpd409\n  -vsv \"admin:very_s3cret\"\n```\n\nTo create the vault secret for the CA bundle:\n```\n./cp-deploy.sh vault set \\\n  -vs cpd409-ca-bundle\n  -vsf /tmp/ca.crt\n```\n\nWhere `ca.crt` looks something like this:\n```\n-----BEGIN CERTIFICATE-----\nMIIFszCCA5ugAwIBAgIUT02v9OdgdvjgQVslCuL0wwCVaE8wDQYJKoZIhvcNAQEL\nBQAwaTELMAkGA1UEBhMCVVMxETAPBgNVBAgMCE5ldyBZb3JrMQ8wDQYDVQQHDAZB\ncm1vbmsxFjAUBgNVBAoMDUlCTSBDbG91ZCBQYWsxHjAcBgNVBAMMFUlCTSBDbG91\n...\nmcutkgtbkq31XYZj0CiM451Qp8KnTx0=\n-----END CERTIFICATE-\n```\n\nAn example of configuring the private registry for a `cp4d` object is below:\n```\ncp4d:\n- project: zen-40\n  openshift_cluster_name: {{ env_id }}\n  cp4d_version: 4.0.9\n  openshift_storage_name: ocs-storage\n  image_registry_name: cpd409\n```\n\nThe Cloud Pak for Data installation refers to the `cpd409` `image_registry` object.\n\nIf the `ibm_cp_entitlement_key` secret is in the vault at the time of running the deployer, the required images will be mirrored from the entitled registry to the private registry. If all images are already available in the private registry, just specify the `--skip-mirror-images` flag when you run the deployer.","fileAbsolutePath":"/home/runner/work/cloud-pak-deployer/cloud-pak-deployer/doc/src/pages/cpd-design/components/private-registry/index.mdx"}}},"staticQueryHashes":["1364590287","137577622","137577622","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","768070550"]}